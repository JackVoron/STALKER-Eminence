artifacts = {
    grav = 
    {
        level_1 = 
        {
            {
                name = "[99ff33]Выверт",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816600/830557C5DDF00F3BD5910F7A62A1377C6A5942AE/"
            },
            {
                name = "[99ff33]Кровь камня",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816285/D186264F1EA2B22D01A497798CAA22957E734351/"
            },
            {
                name = "[99ff33]Медуза",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817141/EC3FBEC1706B6C03D6441A6DCBFA0B9084980E80/"
            },
        },
        level_2 = 
        {
            {
                name = "[33ccff]Грави",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816671/2BE86269C98B38B10724F3D223E01C6FDD9A4BB1/"
            },
            {
                name = "[33ccff]Ломоть мяса",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817531/B8FF830CD5C5CFE89A33F721816A38B1653DBEAE/"
            },
            {
                name = "[99ff33]Каменный цветок",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818459/EBF60EB561B423B0C607A6908C1ADF696083C8CC/"
            },
        }, 
        level_3 = 
        {
            {
                name = "[ff9900]Золотая рыбка",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816908/37DECE563AB4E9332FF3669469A291C39D6E858E/"
            },
            {
                name = "[33ccff]Душа",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818389/58EA35371FA161CC2243D88C7655EC4411ED677F/"
            },
            {
                name = "[99ff33]Ночная звезда",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818177/4BDCFF0C080D58B08CE24457CE97F080BB6250F2/"
            },
        }, 
    },
    electro = 
    {
        level_1 = 
        {
            {
                name = "[99ff33]Бенгальский огонь",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816816/9A5352C58855BBA2686411DC8582E12DA633E161/"
            },
            {
                name = "[99ff33]Пустышка",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817455/E89699724F6B35B9F174857BF94E1889175C3A7E/"
            },
        },
        level_2 = 
        {
            {
                name = "[33ccff]Электрон",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746810355/2DAFFE15B6E5F43C25F67CC100075E690CF02641/"
            },
            {
                name = "[99ff33]Вспышка",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817758/2755D0967137F0C1D3F295CD1476D29853F535E6/"
            },
        }, 
        level_3 = 
        {
            {
                name = "[ff9900]Лунный свет",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817248/0BD53A75ED0B047339585E326327163885BAAE2D/"
            },
            {
                name = "[ff9900]Снежинка",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817681/2D5590D939541DAF9B9DB57E6BC36861AC0EF89F/"
            },
        }, 
    },
    pyro = 
    {
        level_1 = 
        {
            {
                name = "[99ff33]Капля",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816529/CD2A5D61F826EF30C9E2B523B8E640FA4D1BE6AD/"
            },
            {
                name = "[99ff33]Кристалл",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817021/A6A2484CB1F787D3D2FA4F9F417702D3BF812527/"
            },
        },
        level_2 = 
        {
            {
                name = "[33ccff]Мамины бусы",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817612/BAF55381A1C4451741FC63D4496F8335B21BE443/"
            },
            {
                name = "[99ff33]Глаз",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818326/1D119FC998ED4BFB520D8968B9175497FFAF6738/"
            },
        }, 
        level_3 = 
        {
            {
                name = "[ff9900]Огненный шар",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817927/DBE09DFD77574C78732724D53DC0214168BE0387/"
            },
            {
                name = "[ff9900]Пламя",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817372/72EF56FB7EE40D5AD957F9512DD32AE44EB20CD8/"
            },
        }, 
    },
    toxic = 
    {
        level_1 = 
        {
            {
                name = "[99ff33]Колючка",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818098/340973343174E29919D8519EE9BF09A5C1819571/"
            },
            {
                name = "[99ff33]Слизь",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818542/8D456612B070D4E4B304BE333BCB609333F8800A/"
            },
        },
        level_2 = 
        {
            {
                name = "[33ccff]Кристальная колючка",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818254/F21C4096E4FCCE9C9C8B92F94EF03101B47FEFC2/"
            },
            {
                name = "[33ccff]Слизняк",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818013/2266DA7B223CF6E8DBB57C483009DE8029763E83/"
            },
        }, 
        level_3 = 
        {
            {
                name = "[ff9900]Морской ёж",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746818612/EBDFB3890013A139051CEF4412B1C56CE9964178/"
            },
            {
                name = "[33ccff]Слюда",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746817837/FF0D812C5A1FAEFE7C519AE5BA30B9CCA966A84A/"
            },
            {
                name = "[99ff33]Светляк",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816374/FA1D12EC82BDD0395750E8CA60A7CC0BD6B03AB8/"
            },
            {
                name = "[33ccff]Пузырь",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816746/70A1406D8AEA0BCDF9E9DC4F81635C6DC568C9C9/"
            },
            {
                name = "[99ff33]Колобок",
                object = "http://cloud-3.steamusercontent.com/ugc/1922503068746816450/AC653C7A21F6EE050746B5CEEDC686E75F70C9C2/"
            },
        }, 
    },
}


anomalies_info = {
    {
        name = "Трамплин",
        color = "968F7C",
        font_color = "281102",
        rgb = {150, 143, 124},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800912499/ACE9CE23DABB89A8C4C789CE9D081D11437E48C9/",
        artifact_type = artifacts.grav,
    },
    {
        name = "Воронка",
        color = "968F7C",
        font_color = "281102",
        rgb = {150, 143, 124},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800909974/EA1C8957709348B47CBB22C57F9147C005DF210C/",
        artifact_type = artifacts.grav,
    },
    {
        name = "Карусель",
        color = "968F7C",
        font_color = "281102",
        rgb = {150, 143, 124},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800908818/0B0E23A8ABE39A3EB55F17D4735FC4E43B5D148A/",
        artifact_type = artifacts.grav,
    },
    {
        name = "Электра",
        color = "4C6C82",
        font_color = "C1A829",
        rgb = {76, 108, 130},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800913791/F8F447491E7150EF610CF16FA7F6EDC5A9A4A415/",
        artifact_type = artifacts.electro,
    },
    {
        name = "Жарка",
        color = "B3523E",
        font_color = "C1A829",
        rgb = {179, 82, 62},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800909397/9CE297A2ACECB251EF1C79C29A208B1A0EA4F4B0/",
        artifact_type = artifacts.pyro,
    },
    {
        name = "Химическая угроза",
        color = "5A8B49",
        font_color = "C1A829",
        rgb = {90, 139, 73},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800913128/2035EDC3C71A6FEEDF7D1DE50D9B00E3B7A827C5/",
        artifact_type = artifacts.toxic,
    },
    {
        name = "Радиационная угроза",
        color = "81771E",
        font_color = "281102",
        rgb = {129, 119, 30},
        field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800911928/C69FE5821526582A9D228267ED7305E35F136F43/"
    },
}

fields_chance_by_level = {
    {
        50, --anomaly
        30, --radiation
    },
    {
        60, --anomaly
        30, --radiation
    },
    {
        60, --anomaly
        40, --radiation
    }
}

loot_chance_by_level = {
    {
        80, 100, -1, -1
    },
    {
        10, 90, 100, -1
    },
    {
        -1, 10, 90, 100
    }
}

fields_damage_by_level = {
    { 3, 4, 4, 5, 5, 5, 6, 6, 7 },
    { 5, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 10 },
    { 7, 8, 8, 9, 9, 10, 10, 10, 11, 11, 12 }
}

symbols = {"I", "II","III"}
snap_points = {}

empty_field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800911370/98EF29212F3D4F7AF5F8A4181E3A91A223C89A22/"
unknown_field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800906313/4A4934250831BD138CE73EEEEF93178B9EB73750/"
loot_field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800910831/664E36CA72D3211EF23D15E8C12DE4DA86902FB5/" 
artifact_field_image = "http://cloud-3.steamusercontent.com/ugc/1878591893800753770/D3012AF8FB1F8984056F1C1AC6D03777E30816CE/"

counter = 0
current_anomaly_level = 1
current_anomaly_type = nil
artifact_quantity = 0
loot_quantity = 0
found_artifacts = 0
found_loot = 0
zone_guid = nil
objects = nil
artifact_point = nil
bag_point = nil
isSpawned = false

field_script_start = [[
function onLoad()
    self.createButton({
        click_function = "none",
        function_owner = self,
        label          = ]]
            
field_script_end = [[
,
        position       = {0,-0.1,0},
        rotation       = {-165,180,0},
        width          = 0,
        height         = 0,
        font_size      = 650,
        color          = {0,0,0},
    })
    
    function none()
        return
    end
end
]]

script = [[
function onLoad()
    saved = self.memo
    loaded = JSON.decode(saved)
    memory = loaded[1]
    anomaly_params = loaded[2]
    self.addContextMenuItem("Выложить", unpackAnomaly)
end

function unpackAnomaly()
    bag_clone = self.clone()
    local anomaly = getObjectFromGUID(bag_clone.getGMNotes())
    local anomaly_pos = anomaly.getPosition()
    anomaly.call("setAnomalyFromBag", anomaly_params)

    for guid, obj_params in pairs(memory) do
        local new_pos = {obj_params.pos[1], obj_params.pos[2], obj_params.pos[3]}
        new_pos[1] = new_pos[1] + anomaly_pos[1]
        new_pos[3] = new_pos[3] + anomaly_pos[3]
        local obj = bag_clone.takeObject({
            position          = new_pos,
            callback_function = function(obj)
                    obj.setLock(obj_params.lock)
                    obj.setPosition(new_pos)
                    obj.setRotation(obj_params.rot)
                end,
            guid              = guid,
        })
        Wait.frames(function()
            obj.setPosition(new_pos)
        end, 30)
    end

    bag_clone.destruct()
end
]]    

function onSave()
    saved_data = JSON.encode({current_anomaly_type, current_anomaly_level, artifact_quantity, loot_quantity, isSpawned})
    return saved_data
end

function onLoad(saved_data)
    createButtons()

    if saved_data ~= "" then
        loaded_data = JSON.decode(saved_data)
        isSpawned = loaded_data[5]
        if isSpawned == true then         
            self.editButton({index = loaded_data[1] - 1, color = {0,0,0,0.85}, hover_color = {0,0,0,0.85}})
            current_anomaly_type = loaded_data[1]
            current_anomaly_level = loaded_data[2]
            self.editButton({index = 11, label = "[b]" .. symbols[current_anomaly_level] .. "[-]"})
            artifact_quantity = loaded_data[3]
            loot_quantity = loaded_data[4]
        end
    end
    
    self.addContextMenuItem("Обнулить счётчик", function() counter = 0 
                                                self.editButton({index = 13, label = "[b]" .. counter}) 
                                                end)
    for i, snap_point in pairs(self.getSnapPoints()) do
        if i <= 100 then 
            snap_points[i] = snap_point
        elseif i == 101 then
            artifact_point = snap_point
        elseif i == 102 then
            bag_point = snap_point
            break
        end
    end
end

function createButtons()
    for i = 1,7 do
        local funcname = "chooseAnomaly" .. i
        local func = function(obj, player_color, alt_click) chooseAnomaly(obj, player_color, alt_click, i) end
        self.setVar(funcname, func)
        self.createButton({
            click_function = funcname,
            function_owner = self,
            position       = {-7.2,0.6,-5.253 + 1.751 * (i - 1)},
            width          = 880,
            height         = 880,
            color          = {0,0,0,0},
            hover_color    = {0,0,0,0},
            tooltip        = "[b][".. anomalies_info[i].color .."]" .. anomalies_info[i].name .. "[-]",
        })      
    end
    self.createButton({
        click_function = "createAnomaly",
        function_owner = self,
        position       = {0,0.6,-7.7},
        width          = 2300,
        height         = 400,
        color          = {0,0,0,0},  
    })

    self.createButton({
        click_function = "deleteAnomaly",
        function_owner = self,
        position       = {0,0.6,-6.725},
        width          = 2300,
        height         = 400,
        color          = {0,0,0,0},  
    })

    self.createButton({
        click_function = "UseGMZone",
        function_owner = self,
        position       = {5.25,0.6,-7.2},
        width          = 880,
        height         = 880,
        color          = {0,0,0,0},
        tooltip        = "[b][281102]Создать/удалить прячущую зону[-]"  
    })

    self.createButton({
        click_function = "changeAnomalyLevel",
        function_owner = self,
        position       = {-7.2,0.6,-7.2},
        width          = 880,
        height         = 880,
        color          = {0,0,0,0},
        hover_color    = {0,0,0,0},
        tooltip        = "[b][968F7C]Сменить уровень аномалии[-]",
    })

    self.createButton({
        click_function = "changeAnomalyLevel",
        function_owner = self,
        label          = "[b]" .. symbols[1],
        position       = {-7.2,0.6,-7.1},
        width          = 0,
        height         = 0,
        font_size      = 650,
        font_color     = {0.74,0.71,0.42,0.32}, 
    })

    self.createButton({
        click_function = "changeCounter",
        function_owner = self,
        position       = {7.2,0.6,-7.2},
        width          = 880,
        height         = 880,
        color          = {0,0,0,0},
        hover_color    = {0,0,0,0},
    })

    self.createButton({
        click_function = "changeCounter",
        function_owner = self,
        label          = "[b]" .. 0,
        position       = {7.2,0.6,-7.155},
        width          = 0,
        height         = 0,
        font_size      = 560,
        font_color     = {0.74,0.71,0.42,0.32}, 
    })

    self.createButton({
        click_function = "pickUpArtifact",
        function_owner = self,
        position       = {-5.225,0.6,-7.2},
        width          = 880,
        height         = 880,
        color          = {0,0,0,0},
        tooltip        = "[b][965375]Подобрать артефакт[-]",
    })

    self.createButton({
        click_function = "pickUpLoot",
        function_owner = self,
        position       = {-3.425,0.6,-7.2},
        width          = 880,
        height         = 880,
        color          = {0,0,0,0},
        tooltip        = "[b][815029]Подобрать хабар[-]",
    })

    self.createButton({
        click_function = "saveAnomaly",
        function_owner = self,
        position       = {7.2,0.6,-5.253},
        width          = 880,
        height         = 880,
        color          = {0,0,0,0},
        hover_color    = {0,0,0,0},
        tooltip        = "[b][281102]Сохранить аномалию[-]" ,
    })  
end

function chooseAnomaly(obj, player_color, alt_click, i)
    if Player[player_color].admin == false then
        return
    end

    if isSpawned == true then
        broadcastToColor("[b][968F7C]Аномалия уже создана[/b][-]", player_color)
        return
    end

    for i = 1,7 do
        self.editButton({index = i-1, color = {0,0,0,0}, hover_color = {0,0,0,0}})
    end
    self.editButton({index = i-1, color = {0,0,0,0.85}, hover_color = {0,0,0,0.85}})

    current_anomaly_type = i
end

function createAnomaly(obj, player_color, alt_click)
    if Player[player_color].admin == false then
        return
    end
    
    if current_anomaly_type == nil then
        broadcastToColor("[b][968F7C]Тип аномалии не выбран[/b][-]", player_color)
        return
    end
    
    if isSpawned == true then
        broadcastToColor("[b][968F7C]Аномалия уже создана[/b][-]", player_color)
        return
    end

    isSpawned = true

    found_artifacts = 0
    found_loot = 0

    setLootable()
    spawnAnomalyField()
end

function spawnAnomalyField()
    local my_rotation = self.getRotation()
    
    shuffleTable(snap_points)
    for i, snap_point in pairs(snap_points) do

        local image
        local script = ""

        if i <= artifact_quantity then
            image = artifact_field_image  
        elseif i <= loot_quantity + artifact_quantity then
            image = loot_field_image 
        elseif i <= 50 then
            image = empty_field_image     
        else
            rand = math.random(100)
            local chances = fields_chance_by_level[current_anomaly_level]
            local anomaly = anomalies_info[current_anomaly_type]
            local damage = fields_damage_by_level[current_anomaly_level]
            if rand <= chances[1] then
                image = anomaly.field_image
                script = field_script_start .. "'[" .. anomaly.font_color .. "]" .. randomFromTable(damage)  .. "[-]'" .. field_script_end
            elseif rand <= chances[1] + chances[2] then
                image = anomalies_info[7].field_image
                script = field_script_start .. "'[" .. anomalies_info[7].font_color .. "]" .. math.floor(randomFromTable(damage)/2) .. "[-]'" .. field_script_end
            else
                image = empty_field_image           
            end
        end 

        local my_position = self.positionToWorld(snap_point.position)
        local obj = spawnObject({type = "Custom_Tile", position = my_position, scale = {0.675, 1.00, 0.675}, 
        rotation = my_rotation})
        setField(obj, image, script)
    end
end

function setField(obj, f_image, script)
    obj.setCustomObject({
        image = unknown_field_image,
        image_bottom = f_image,
        thickness = 0.1,
    })
    obj.setLock(false)
    obj.setColorTint({0,0,0})
    obj.setLuaScript(script)
    obj.addTag("anomaly_field")
    obj.reload()
end

function deleteAnomaly(obj, player_color)
    if Player[player_color].admin == false then
        return
    end

    createZone()
    Wait.frames(myGetObjects, 2)
    Wait.frames(function()
        for _, obj in pairs(objects) do
            if obj.hasTag("anomaly_field") == true then      
                obj.destruct()
            end
        end
        loot_quantity = 0
        artifact_quantity = 0
    end,
    2)
    isSpawned = false
end

function setLootable()
    local settings = Settings()

    if settings.artifact_quantity == nil or tonumber(settings.artifact_quantity) == nil or tonumber(settings.artifact_quantity) < 0 then
        if current_anomaly_type == 7 then
            artifact_quantity = 0
        else
            artifact_quantity = math.random(0,3)
        end
    else
        artifact_quantity = tonumber(settings.artifact_quantity)
        if current_anomaly_type == 7 then
            anomalies_info[7].artifact_type = artifacts[randomKeyFromTableDictionary(artifacts)]
        end
    end

    if settings.loot_quantity == nil or tonumber(settings.loot_quantity) == nil or tonumber(settings.loot_quantity) < 0 then
        loot_quantity = math.random(2,6)
    else
        loot_quantity = tonumber(settings.loot_quantity)
    end
end

function changeAnomalyLevel(obj, player_color, alt_click)
    if Player[player_color].admin == false then
        return
    end
    
    if isSpawned == true then
        broadcastToColor("[b][968F7C]Аномалия уже создана[/b][-]", player_color)
        return
    end

    if alt_click == false then
        if current_anomaly_level < 3 then
            current_anomaly_level = current_anomaly_level + 1
        else
            current_anomaly_level = 1
        end
    else
        if current_anomaly_level > 1 then
            current_anomaly_level = current_anomaly_level - 1
        else
            current_anomaly_level = 3
        end
    end
    self.editButton({index = 11, label = "[b]" .. symbols[current_anomaly_level] .. "[-]"})
end

function changeCounter(obj, player_color, alt_click)
    if Player[player_color].admin == false then
        return
    end
    if alt_click == false then
        if counter < 99 then
            counter = counter + 1
        end
    else
        if counter > -99 then
            counter = counter - 1
        end
    end
    self.editButton({index = 13, label = "[b]" .. counter .. "[-]"})
end

function UseGMZone(obj, player_color, alt_click)
    if player_color ~= "Black" then
        return
    end
    if zone_guid == nil then
        local my_scale = self.getScale()*29
        local my_pos = self.getPosition()
        local my_rot = self.getRotation()
        local zone = spawnObjectData({
            data = { Name = "FogOfWarTrigger",
            Transform = {
                posX = my_pos[1],
                posY = my_pos[2] + 1,
                posZ = my_pos[3],
                rotX = my_rot[1],
                rotY = my_rot[2],
                rotZ = my_rot[3],
                scaleX = my_scale[1],
                scaleY = 4,
                scaleZ = my_scale[3]
            },
            Value = 0,
            ColorDiffuse = { r = 0.25, g = 0.25, b = 0.25, a = 0.25 },
            LayoutGroupSortIndex = 0,
            Locked = true,
            Grid = true,
            Snap = true,
            IgnoreFoW = false,
            MeasureMovement = false,
            DragSelectable = true,
            Tooltip = true,
            Sticky = true,
            Autoraise = true,
            GridProjection = false,
            HideWhenFaceDown = false,
            Hands = false,
            FogColor = "Black",
            FogSeethrough = true,
            FogReverseHiding = false,
            FogHidePointers	= true,
        }})
        zone_guid = zone.getGUID()
    else
        if getObjectFromGUID(zone_guid) then
            getObjectFromGUID(zone_guid).destruct()
            zone_guid = nil
        end
    end
end

function pickUpArtifact(obj, player_color)
    if found_artifacts >= artifact_quantity then
        printToAll("[b][965375]Артефакты отсутствуют[/b][-]", player_color)
        return
    end

    local available_artifacts = anomalies_info[current_anomaly_type].artifact_type["level_" .. math.random(1, current_anomaly_level)]
    local artifact = available_artifacts[math.random(#available_artifacts)]
    local my_posistion = self.positionToWorld(artifact_point.position)
    local my_rotation = self.getRotation()
    obj = spawnObject({
        type              = "Custom_AssetBundle",
        position          = my_posistion,
        scale             = {2, 0.1, 2},
        rotation          = my_rotation,
    })
    obj.setCustomObject({assetbundle = artifact.object})
    obj.setName(artifact.name)
    obj.reload()

    found_artifacts = found_artifacts + 1
end

function pickUpLoot(obj, player_color)
    if found_loot >= loot_quantity then
        printToAll("[b][815029]Предметы отсутствуют[/b][-]", player_color)
        return
    end

    local settings = Settings()
    local rand = math.random(100)
    local loot_tier = loot_chance_by_level[current_anomaly_level]

    if getObjectFromGUID(settings.loot_giver_GUID) then
        local obj = getObjectFromGUID(settings.loot_giver_GUID)
        if rand <= loot_tier[1] then
            obj.call("copyToItem", 1)
            printToAll(Player[player_color].steam_name .. " подобрал [31B32B][i][b]Сокровище I[/b][/i][-]")
        elseif rand <= loot_tier[2] then
            obj.call("copyToItem", 2)
            printToAll(Player[player_color].steam_name .. " подобрал [E7E52C][i][b]Сокровище II[/b][/i][-]")
        elseif rand <= loot_tier[3] then
            obj.call("copyToItem", 3)
            printToAll(Player[player_color].steam_name .. " подобрал [DA1918][i][b]Сокровище III[/b][/i][-]")
        else
            obj.call("copyToItem", 4)
            printToAll(Player[player_color].steam_name .. " подобрал [404040][i][b]Сокровище S[/b][/i][-]")
        end
    else
        if rand <= loot_tier[1] then
            printToAll(Player[player_color].steam_name .. " подобрал [31B32B][i][b]Сокровище I[/b][/i][-]")
        elseif rand <= loot_tier[2] then
            printToAll(Player[player_color].steam_name .. " подобрал [E7E52C][i][b]Сокровище II[/b][/i][-]")
        elseif rand <= loot_tier[3] then
            printToAll(Player[player_color].steam_name .. " подобрал [DA1918][i][b]Сокровище III[/b][/i][-]")
        else
            printToAll(Player[player_color].steam_name .. " подобрал [404040][i][b]Сокровище S[/b][/i][-]")
        end
    end

    found_loot = found_loot + 1
end

function saveAnomaly(obj, player_color)
    if isSpawned == false then
        broadcastToColor("[b][968F7C]Аномалия не создана[/b][-]", player_color)
        return
    end

    if player_color ~= "Black" then
        return
    end
    createZone()
    Wait.frames(myGetObjects, 2)

    memory = {}

    bag = spawnObject({
        type              = "Bag",
        position          = self.positionToWorld(bag_point.position),
        scale             = {0.7,0.7,0.7},
        snap_to_grid      = true,
    })
    local rgb = anomalies_info[current_anomaly_type].rgb
    bag.setColorTint({rgb[1]/255, rgb[2]/255, rgb[3]/255})
    bag.setName("[b][" .. anomalies_info[current_anomaly_type].color .. "]" .. anomalies_info[current_anomaly_type].name)
    Wait.frames(function()
        bag.setLock(true)
        for _, object in pairs(objects) do
            if object.hasTag("anomaly_field") == true then
                local obj_pos = object.getPosition()
                local field_pos = self.getPosition()
                memory[object.getGUID()] = {pos = {obj_pos[1] - field_pos[1], obj_pos[2], obj_pos[3] - field_pos[3]}, lock = object.getLock(), rot = object.getRotation()}
                bag.putObject(object)
            end
        end
        bag.setLock(false)
        bag.setLuaScript(script)
        saved = {memory, {current_anomaly_type, current_anomaly_level, artifact_quantity, loot_quantity}}
        bag.memo = JSON.encode(saved)
        bag.setGMNotes(self.getGUID())
        bag.reload()
    end, 5)
    Wait.frames(function()
        loot_quantity = 0
        artifact_quantity = 0
        isSpawned = false
    end, 6)
end

function setAnomalyFromBag(t)
    found_artifacts = 0
    found_loot = 0

    deleteAnomaly(self, "Black")
    chooseAnomaly(self, "Black", false, t[1])

    current_anomaly_level = t[2]
    Wait.frames(function()
        artifact_quantity = t[3]
        loot_quantity = t[4]
        isSpawned = true
    end, 6)

    self.editButton({index = 11, label = "[b]" .. symbols[current_anomaly_level] .. "[-]"})
end

function Settings()
    local temp = self.getGMNotes()
    local settings = {}
    for k in string.gmatch(temp, "([^\n]+)") do
        for name, value in string.gmatch(k, "(.+)%s+=%s+(.+)") do
            settings[name] = value
        end
    end
    return settings
end

function shuffleTable(table)
    for i = 1, #table do
        local j = math.random(#table)
        table[i], table[j] = table[j], table[i]
    end
end

function randomFromTable(t)
    return t[math.random(#t)]
end

function randomKeyFromTableDictionary(t)
    local keys = {}
    for key, _ in pairs(t) do
        table.insert(keys, key)
    end
    return keys[math.random(#keys)]
end

function createZone()
    local my_scale = self.getScale()
    my_scale[1] = my_scale[1]*25
    my_scale[2] = 1
    my_scale[3] = my_scale[3]*25
    local my_position = self.getPosition()+vector(0, 0.9, 0)
    spawnObject({type = "ScriptingTrigger", position = my_position, scale = my_scale, rotation = self.getRotation(), callback_function = function(obj) setZone(obj) end})
end

function setZone(obj)
    zone = obj.getGUID()
    Wait.frames(function()
        obj.destruct()
        end,
        6)
end

function myGetObjects()
    objects = getObjectFromGUID(zone).getObjects()
end